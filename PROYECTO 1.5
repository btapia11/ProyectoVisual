#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#define AA 2020//año actual
#define N 20 //TAMAÑO DEL VECTOR

//estructura INTERNA
struct fecha{
    int mes;
    int dia;
    int anio;
};

struct tiempo{
    int hh;
    int mint;
    int ss;
};

struct prueba{
    char apellido_1 [50];
    char apellido_2 [50];
    char nombre_1 [50];
    char nombre_2 [50];
    char ingreso[50];
    char genero[50];
    char categoria[50];
    int dorsal;
    int tiempo;
}prueba[N];

//estructura EXTERNA
struct corredor{
    char nombre [50];
    char apellido[50];
    int dorsal;
    struct fecha ingreso;
    char genero[2];
    char categoria[15];
    int tiempo;
}corredores[N];

int i,j,k;
//PROTOTIPOS--------------------------------------------------------------------
int validar_fercha();
int validar_tiempo();
void guardar_txt();
void mostrar_corredor();
void mostrar_ordenados();
void sub_menu();
void registrar_tiempos();

//DEFINICIONES-------------------------------------------------------------------
int validar_fecha(){
    int bandera=0;
    if(corredores[i].ingreso.anio == AA){
        if (corredores[i].ingreso.mes == 8 || corredores[i].ingreso.mes == 9){
            switch(corredores[i].ingreso.mes){
                case 8:
                    if(corredores[i].ingreso.dia == 31)
                        bandera = 1;
                    else
                        bandera = 0;
                    break;
                case 9:
                    if(corredores[i].ingreso.dia >= 1 && corredores[i].ingreso.dia <= 7)
                        bandera = 1;
                    else
                        bandera = 0;
                    break;
            }
        }
    }
    else{
        bandera = 0;
    }
    return bandera;
}

void guardar_txt(){
    int test,opc;
    int bandera = 0;
    int bandera2;
    char nombre2[50];

    i = 0;

    FILE *fichero;
    while(bandera==0){
        int tiempo_inicial=0;
        bandera2 = 0;
        fflush(stdin);
        srand(time(NULL)); //Para reiniciar el contador de los valores randomicos.


        system("cls");
        printf("\n**INGRESE LOS DATOS DEL COMPETIDOR***\n\n");
        printf("\nIngrese su nombre completo(apellidos, nombres): ");
        gets(nombre2);
        strupr(nombre2);
        //scanf("%s",nombre2);//gets(nombre2);

        if(strcmp(nombre2,"FIN")==0)
        {
            bandera = 1;
        }
        else{
            test = rand () % 9999;
            strcpy(corredores[i].nombre, nombre2);

            do{
                printf("Ingrese la fecha  (dd/ mm/ aaaa): ");
                scanf("%i/%i/%i",&corredores[i].ingreso.dia,&corredores[i].ingreso.mes,&corredores[i].ingreso.anio);
                fflush(stdin);
                if(validar_fecha()==0){
                    printf("FUERA DE LA FECHA DE INSCRIPCION!\n");
                }
            }while(validar_fecha()==0);
            corredores[i].dorsal = test;
            fflush(stdin);
            printf("Ingrese el genero (M-masculino, F-femenino): ");
            scanf("%c",corredores[i].genero);
            strupr(corredores[i].genero);
            while(bandera2==0){
                if((strcmp(corredores[i].genero,"F")==0) || (strcmp(corredores[i].genero,"M")==0)){
                    bandera2 = 1;
                }
                else{
                    bandera2 = 0;
                    printf("Ingrese el genero correctamente (M-masculino, F-femenino): ");
                    scanf("%s",corredores[i].genero);
                    strupr(corredores[i].genero);
                }
            }
            fflush(stdin);

            sub_menu();
            corredores[i].tiempo=0;
            fichero = fopen("majo.txt", "a");
            fprintf(fichero,"%s\n",corredores[i].nombre);
            fprintf(fichero,"%d/%d/%d\n",corredores[i].ingreso.mes,corredores[i].ingreso.dia,corredores[i].ingreso.anio);
            fprintf(fichero,"%s\n",corredores[i].genero);
            fprintf(fichero,"%s\n",corredores[i].categoria);
            fprintf(fichero,"%d\n",corredores[i].dorsal);
            fprintf(fichero,"%d\n",corredores[i].tiempo);
            fprintf(fichero, "%c", '\n');

            fclose(fichero);

            bandera =0;
            i++;
        }
    }
    for(j=0;j<i;j++){
    printf("%s \n",corredores[j].nombre);
    }
}

void mostrar_corredor(){
    char linea[1024];
    FILE *fich;
    fich = fopen("majo.txt", "r");

    if(fich == NULL){
        printf("ERROR: el archivo no existe");
    }
    else{
        while(fgets(linea, 1024, (FILE*) fich)) {
            printf(" %s \n", linea);
        }
        fclose(fich);
    }
    //Lee línea a línea y escribe en pantalla hasta el fin de fichero
}

void mostrar_ordenados(){
    FILE * fp, * fp2;
    int bandera;
    i=0;
    struct tiempo tp[N];
    fp = fopen ("majo.txt" , "r");
    if(fp == NULL){

        printf("el no contiene un archivo txt");

    }
    else{
        while(!feof(fp)){
                fscanf(fp,"%s",prueba[i].apellido_1);
                fscanf(fp,"%s",prueba[i].apellido_2);
                fscanf(fp,"%s",prueba[i].nombre_1);
                fscanf(fp,"%s",prueba[i].nombre_2);
                fscanf(fp,"%s",prueba[i].ingreso);
                fscanf(fp,"%s",prueba[i].genero);
                fscanf(fp,"%s",prueba[i].categoria);
                fscanf(fp,"%i",&prueba[i].dorsal);
                fscanf(fp,"%i",&prueba[i].tiempo);
                i++;

        }
        fclose(fp);
    }

    fp = fopen ("majo.txt" , "w");

    for(int j = 0 ; j<i-1;j++){
            bandera = 0;
            fprintf(fp,"%s %s %s %s \n",prueba[j].apellido_1,prueba[j].apellido_2,prueba[j].nombre_1,prueba[j].nombre_2);
            fprintf(fp,"%s\n",prueba[j].ingreso);
            fprintf(fp,"%s \n",prueba[j].genero);
            fprintf(fp,"%s\n",prueba[j].categoria);
            fprintf(fp,"%d\n",prueba[j].dorsal);
            printf("Ingrese el tiempo del participante [hh mint ss] %s %s %s %s \n",prueba[j].apellido_1,prueba[j].apellido_2,prueba[j].nombre_1,prueba[j].nombre_2);
            scanf("%i %i %i",&tp[j].hh,&tp[j].mint,&tp[j].ss);

            while(bandera==0){

                scanf("%i %i %i",&tp[j].hh,&tp[j].mint,&tp[j].ss);
                if((tp[j].hh >= 0 && tp[j].hh<=23) && (tp[j].mint >= 0 && tp[j].mint <=59)&&(tp[j].ss >= 0 && tp[j].ss <=59) ){
                    printf("entra");
                    bandera=1;
                }
                else{
                    printf("ERROR: Ingrese el tiempo del participante %s %s %s %s ",prueba[j].apellido_1,prueba[j].apellido_2,prueba[j].nombre_1,prueba[j].nombre_2);
                    bandera= 0;
                }

            }



            fprintf(fp,"%i %i %i \n",tp[j].hh,tp[j].mint,tp[j].ss);
            fprintf(fp,"%c",'\n');




    }

    fclose(fp);






}

/*int validar_tiempo(){

    int bandera =0;
    if((corredores[i].realizado.hh >= 0 && corredores[i].realizado.hh <=23)&& (corredores[i].realizado.mint >= 0 && corredores[i].realizado.mint <=59)&&(corredores[i].realizado.ss >= 0 && corredores[i].realizado.ss <=59) )
        bandera= 1;
    else
        bandera= 0;
    return bandera;
}*/

void sub_menu(){
    int opc;
    do{
    printf("Seleccione el numero segun su categoria:\n");
    printf("\t[1]. Juvenil (12 - 19 anios)\n");
    printf("\t[2]. Elite (20 - 39 anios)\n");
    printf("\t[3]. Master (40 - 59 anios)\n");
    printf("\t[4]. Supermaster (60 anios en adelante)\n");
    printf("\t[5]. Discapacitados (60 anios en adelante)\n");
    scanf("%i",&opc);
        printf("ERROR. Seleccione el numero segun su categoria:\n");
        switch(opc){
            case 1:
                strcpy(corredores[i].categoria,"JUVENIL");
                break;
            case 2:
                strcpy(corredores[i].categoria,"ELITE");
                break;
            case 3:
                strcpy(corredores[i].categoria,"MASTER");
                break;
            case 4:
                strcpy(corredores[i].categoria,"SUPERMASTER");
                break;
            case 5:
                strcpy(corredores[i].categoria,"DISCAPACITADOS");
                break;
        }
    }while(opc!=5 && opc!=4 && opc!=3 && opc!=2 && opc!=1);

}
void registrar_tiempo(){
    FILE * fp, * fp2;
    int bandera;
    i=0;
    struct tiempo tp[N];
    fp = fopen ("majo.txt" , "r");
    if(fp == NULL){

        printf("el no contiene un archivo txt");

    }
    else{
        while(!feof(fp)){
                fscanf(fp,"%s",prueba[i].apellido_1);
                fscanf(fp,"%s",prueba[i].apellido_2);
                fscanf(fp,"%s",prueba[i].nombre_1);
                fscanf(fp,"%s",prueba[i].nombre_2);
                fscanf(fp,"%s",prueba[i].ingreso);
                fscanf(fp,"%s",prueba[i].genero);
                fscanf(fp,"%s",prueba[i].categoria);
                fscanf(fp,"%i",&prueba[i].dorsal);
                fscanf(fp,"%i",&prueba[i].tiempo);
                i++;

        }
        fclose(fp);
    }

    fp = fopen ("majo.txt" , "w");

    for(int j = 0 ; j<i-1;j++){
            bandera = 0;
            fprintf(fp,"%s %s %s %s \n",prueba[j].apellido_1,prueba[j].apellido_2,prueba[j].nombre_1,prueba[j].nombre_2);
            fprintf(fp,"%s\n",prueba[j].ingreso);
            fprintf(fp,"%s \n",prueba[j].genero);
            fprintf(fp,"%s\n",prueba[j].categoria);
            fprintf(fp,"%d\n",prueba[j].dorsal);
            printf("Ingrese el tiempo del participante [hh mint ss] %s %s %s %s \n",prueba[j].apellido_1,prueba[j].apellido_2,prueba[j].nombre_1,prueba[j].nombre_2);
            scanf("%i %i %i",&tp[j].hh,&tp[j].mint,&tp[j].ss);

            while(bandera==0){

                scanf("%i %i %i",&tp[j].hh,&tp[j].mint,&tp[j].ss);
                if((tp[j].hh >= 0 && tp[j].hh<=23) && (tp[j].mint >= 0 && tp[j].mint <=59)&&(tp[j].ss >= 0 && tp[j].ss <=59) ){
                    printf("entra");
                    bandera=1;
                }
                else{
                    printf("ERROR: Ingrese el tiempo del participante %s %s %s %s ",prueba[j].apellido_1,prueba[j].apellido_2,prueba[j].nombre_1,prueba[j].nombre_2);
                    bandera= 0;
                }

            }
            fprintf(fp,"%i %i %i \n",tp[j].hh,tp[j].mint,tp[j].ss);
            fprintf(fp,"%c",'\n');
    }
    fclose(fp);

}

void contador_caregoria(){
    FILE * fp;
    int bandera;
    i=0;
    struct tiempo tp[N];
    fp = fopen ("majo.txt" , "r");
    if(fp == NULL){

        printf("el no contiene un archivo txt");

    }
    else{
        while(!feof(fp)){
                fscanf(fp,"%s",prueba[i].apellido_1);
                fscanf(fp,"%s",prueba[i].apellido_2);
                fscanf(fp,"%s",prueba[i].nombre_1);
                fscanf(fp,"%s",prueba[i].nombre_2);
                fscanf(fp,"%s",prueba[i].ingreso);
                fscanf(fp,"%s",prueba[i].genero);
                fscanf(fp,"%s",prueba[i].categoria);
                fscanf(fp,"%i",&prueba[i].dorsal);
                fscanf(fp,"%i",&prueba[i].tiempo);
                i++;

        }
        fclose(fp);
        int jub = 0,e=0,m=0,s=0,d=0,jub_f=0,jub_m=0,e_f=0,e_m=0,m_f=0,m_m=0,s_f=0,s_m=0,d_f=0,d_m=0;
        for(int j = 0;j<i;j++){

            if(strcmp(prueba[j].categoria,"JUVENIL")==0){
                if(strcmp(prueba[j].genero,"F")==0)
                    jub_f++;
                else
                    if(strcmp(prueba[j].genero,"M")==0)
                    jub_m++;

            }

            if(strcmp(prueba[j].categoria,"ELITE")==0){
                if(strcmp(prueba[j].genero,"F")==0)
                    e_f++;
                else
                    if(strcmp(prueba[j].genero,"M")==0)
                    e_m++;
                e++;
            }
            if(strcmp(prueba[j].categoria,"MASTER")==0){
                if(strcmp(prueba[j].genero,"F")==0)
                    m_f++;
                else
                    if(strcmp(prueba[j].genero,"M")==0)
                    m_m++;

            }
            if(strcmp(prueba[j].categoria,"SUPERMASTER")==0){
                if(strcmp(prueba[j].genero,"F")==0)
                    s_f++;
                else
                    if(strcmp(prueba[j].genero,"M")==0)
                    s_m++;

            }

            if(strcmp(prueba[j].categoria,"DISCAPACITADOS")==0){
                if(strcmp(prueba[j].genero,"F")==0)
                    d_f++;
                else
                    if(strcmp(prueba[j].genero,"M")==0)
                    d_m++;

            }
        }
        printf("  \t                  CARRERA 10K               \n");
        printf(" \t             INSCRITOS POR CATEORIA               \n");
        printf("CATEGORIA  \t TOTAL HOMBRES  \t TOTAL MUJERES \n");
        printf("JUVENILES            %d    \t            %d\n", jub_m,jub_f);
        printf("Elite                %d    \t            %d\n",  e_m,e_f);
        printf("MASTER               %d    \t            %d\n",  m_m,m_f);
        printf("Supermaster          %d    \t            %d\n", s_m,s_f);
        printf("DISCAPACITADOS       %d    \t            %d\n", d_m,d_f);

        printf("Total de inscritos: %i ",i-1);
    }
}


void nomina_incritos(){
    FILE * fp;
    i=0;
    struct tiempo tp[N];
    fp = fopen ("majo.txt" , "r");
    if(fp == NULL){

        printf("el no contiene un archivo txt");

    }
    else{
        while(!feof(fp)){
                fscanf(fp,"%s",prueba[i].apellido_1);
                fscanf(fp,"%s",prueba[i].apellido_2);
                fscanf(fp,"%s",prueba[i].nombre_1);
                fscanf(fp,"%s",prueba[i].nombre_2);
                fscanf(fp,"%s",prueba[i].ingreso);
                fscanf(fp,"%s",prueba[i].genero);
                fscanf(fp,"%s",prueba[i].categoria);
                fscanf(fp,"%i",&prueba[i].dorsal);
                fscanf(fp,"%i",&prueba[i].tiempo);
                i++;

        }
    fclose(fp);
    }

	struct prueba aux;
    for(int j = 0;j<i;j++){
        for(int k = 0;k<i;k++){
            if(strcmp(prueba[k-1].apellido_1,prueba[k].apellido_1)>0){
                aux = prueba[k-1];
				prueba[k-1]=prueba[k];
				prueba[k]=aux;
            }

        }

    }

    int t = 0;
    for(t ;t < i-1; t++){
        printf("Los apellidos son %s %i \n",prueba[t].apellido_1,prueba[t].dorsal);
    }

}

//FUNCIÓN PRINCIPAL
int main(){
    char repite = 1;
    int opcion = -1;
    do {
        system("cls");
        printf("\n\t\t\t\t*MARATON 10K QUITO*\n");
        printf("\t \t \t  >> Fundacion Virgen de la Merced <<\n");
        printf("\n\t\t[1]. Registrar corredor \n");
        printf("\t\t[2]. Mostrar listado de Corredores (sin ordenar) \n");
        printf("\t\t[3]. Mostrar listado de Corredores (ordenados)\n");
        printf("\t\t[4]. Registrar tiempo de los corredores \n");
        printf("\t\t[5]. Inscritos por Categoria\n");
        printf("\t\t[6]. Nomina inscritos\n");
        printf("\t\t[7]. Salir\n");
        printf("\n\t\tIngrese su opcion: [ ]\b\b");
        // Lectura segura de un entero
        scanf("%d", &opcion);
        switch (opcion) {
            case 1:
                guardar_txt();
                break;
            case 2:
                mostrar_corredor();
                break;
            case 3:
                mostrar_ordenados();
                break;
            case 4:
                registrar_tiempo();
                break;
            case 5:
                contador_caregoria();
                break;
            case 6:
                nomina_incritos();
                break;
            case 7:
                repite = 0;
                break;
            }
        system("pause");
    } while (repite);
}
